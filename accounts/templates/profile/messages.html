<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat üí¨</title>
    <script src="https://cdn.jsdelivr.net/npm/stream-chat"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 300px;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    .sidebar input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    .user {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .user:hover {
      background-color: #f0f0f0;
    }
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #message-form {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #message-input {
      flex: 1;
      padding: 10px;
    }
    #message-form button {
      padding: 10px 20px;
    }
  </style>
</head>
<body>
    <script>
        console.log("StreamChat type:", typeof StreamChat);  // ‚úÖ should log 'function'
      </script>
<div class="sidebar">
  <input type="text" id="user-search" placeholder="Search users..." />
  <div id="user-list">Loading users...</div>
</div>

<div class="chat-area">
  <div id="chat-box">Select a user to start chatting</div>
  <form id="message-form">
    <input type="text" id="message-input" placeholder="Type your message..." />
    <button type="submit">Send</button>
  </form>
</div>

<script>
let client, currentUserId, channel;

async function initChat() {
  try {
    const tokenResponse = await fetch("/chat/token/");
    const data = await tokenResponse.json();
    setInterval(loadUserList, 15000); 
    client = StreamChat.getInstance(data.api_key);
    await client.connectUser(
      { id: data.user_id, name: data.username },
      data.token
    );

    currentUserId = data.user_id;
    loadUserList();
  } catch (err) {
    console.error("‚ùå Failed to initialize chat:", err);
  }
}

async function loadUserList() {
    try {
      const response = await fetch('/accounts/chat/users/');
      const users = await response.json();
  
      // ‚úÖ Fetch all channels the user is part of
      const channels = await client.queryChannels({
        members: { $in: [currentUserId] }
      });
  
      const unreadCounts = {};
      channels.forEach(ch => {
        const other = Object.values(ch.state.members).find(
          m => m.user_id !== currentUserId
        );
        if (other && ch.countUnread() > 0) {
          unreadCounts[other.user_id] = ch.countUnread();
        }
      });
  
      const searchInput = document.getElementById("user-search");
      const list = document.getElementById("user-list");
  
      function render(usersToRender) {
        list.innerHTML = '';
        if (usersToRender.length === 0) {
          list.innerHTML = '<div>No users found.</div>';
          return;
        }
  
        usersToRender.forEach(user => {
          const div = document.createElement("div");
          div.className = "user";
          const count = unreadCounts[user.userID] || 0;
  
          div.innerHTML = `
            <span>${user.username}</span>
            ${count > 0 ? `<span style="float:right; background:red; color:white; padding:2px 8px; border-radius:20px;">${count}</span>` : ''}
          `;
          div.dataset.id = user.userID.toString();
          list.appendChild(div);
        });
      }
  
      render(users);
  
      searchInput.addEventListener("input", () => {
        const q = searchInput.value.toLowerCase();
        const filtered = users.filter(u => u.username.toLowerCase().includes(q));
        render(filtered);
      });
  
      list.addEventListener("click", e => {
        const targetId = e.target.closest(".user")?.dataset.id;
        if (targetId) startChatWith(targetId);
      });
  
    } catch (err) {
      console.error("‚ùå Error loading user list:", err);
      document.getElementById("user-list").innerHTML = "<div>Error loading users.</div>";
    }
  }
  

async function startChatWith(targetId) {
    const response = await fetch(`/chat/start/${targetId}/`);
    const data = await response.json();
  
    if (data.channel_id) {
      channel = client.channel("messaging", data.channel_id);
      await channel.watch();
  
      await channel.markRead();
  
      renderMessages(channel.state.messages);
  
      channel.on("message.new", () => {
        renderMessages(channel.state.messages);
        loadUserList(); // üîÅ Refresh sidebar for unread counts
      });
    }
  }
  

  function renderMessages(messages) {
    const box = document.getElementById("chat-box");
    box.innerHTML = "";
  
    let lastMyMessage = null;
    for (let i = messages.length - 1; i >= 0; i--) {
      if (messages[i].user.id === currentUserId) {
        lastMyMessage = messages[i];
        break;
      }
    }
  
    messages.forEach(msg => {
      const isMine = msg.user.id === currentUserId;
      const isLastMine = lastMyMessage && msg.id === lastMyMessage.id;
  
      const messageDiv = document.createElement("div");
      messageDiv.style.maxWidth = "70%";
      messageDiv.style.margin = "8px";
      messageDiv.style.padding = "10px";
      messageDiv.style.borderRadius = "12px";
      messageDiv.style.clear = "both";
      messageDiv.style.display = "inline-block";
      messageDiv.style.wordBreak = "break-word";
  
      messageDiv.style.backgroundColor = isMine ? "#007bff" : "#f1f0f0";
      messageDiv.style.color = isMine ? "white" : "black";
      messageDiv.style.float = isMine ? "right" : "left";
  
      const timestamp = new Date(msg.created_at).toLocaleString('en-US', {
        weekday: 'short',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      
      let content = `
        <div><strong>${msg.user.name}</strong></div>
        <div>${msg.text}</div>
        <div style="font-size: 11px; color: #ccc; margin-top: 4px;">${timestamp}</div>
      `;
      // ‚úÖ Seen status for last message I sent
      if (isMine && isLastMine && channel?.state?.read) {
        const seenBy = Object.entries(channel.state.read)
          .filter(([userId, readData]) =>
            userId !== currentUserId &&
            readData.last_read &&
            new Date(readData.last_read) > new Date(msg.created_at)
          )
          .map(([userId]) => userId);
  
        if (seenBy.length > 0) {
          content += `<div style="font-size: 12px; margin-top: 5px; color: lightyellow;">‚úÖ Seen</div>`;
        }
      }
  
      messageDiv.innerHTML = content;
      box.appendChild(messageDiv);
    });
  
    box.scrollTop = box.scrollHeight;
  }
  
  document.getElementById("message-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const input = document.getElementById("message-input");
  
    if (!input.value.trim() || !channel) return;
  
    try {
      await channel.sendMessage({ text: input.value.trim() });
      input.value = '';
      loadUserList(); // refresh unread counts
    } catch (err) {
      console.error("‚ùå Failed to send message:", err);
    }
  });
  

initChat();
</script>

</body>
</html> 

